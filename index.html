<!-- MAIN SCRIPT AREA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CLOUD CONFIGURATION ---
        // üëá TUTOR NOTE: PASTE YOUR FIREBASE KEYS BELOW THIS LINE üëá
        const firebaseConfig = {
            apiKey: "AIzaSyD4-pFeF0ixzfHdGcv01AhI4nRtp9oTnkM",
              authDomain: "classroom-tracker-18ab8.firebaseapp.com",
              projectId: "classroom-tracker-18ab8",
              storageBucket: "classroom-tracker-18ab8.firebasestorage.app",
              messagingSenderId: "119632501455",
              appId: "1:119632501455:web:c23d4d692e948b64a435ba",
              measurementId: "G-YJ0D0LGB9E"
        };
        // üëÜ PASTE ABOVE THIS LINE üëÜ
        
        // --- 2. LOCAL DATA FALLBACK ---
        let students = JSON.parse(localStorage.getItem('aestheticTutorData')) || {};
        const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

        let app, auth, db, appId, currentUser = null;

        // --- 3. CLOUD CONNECTION LOGIC ---
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = 'pastel-tutor-tracker'; // Master App ID

                // Login invisibly just to get database access
                signInAnonymously(auth).catch(e => console.log("Auth Issue:", e));

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        const cloudStatus = document.getElementById('cloudStatus');
                        cloudStatus.innerText = '‚òÅÔ∏è Cloud Synced (Master Mode)';
                        cloudStatus.style.color = '#b7e4c7'; 
                        loadFromCloud();
                    }
                });
            } catch(e) {
                console.error("Firebase setup error:", e);
            }
        }

        // üëá THIS IS THE FIX: Reading from the MASTER public folder üëá
        function loadFromCloud() {
            if (!db) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tutorApp', 'masterDatabase');
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    students = docSnap.data().students || {};
                    localStorage.setItem('aestheticTutorData', JSON.stringify(students)); 
                    
                    window.updateLogClassDropdown();
                    window.updateInvoiceDropdown();
                    if (document.getElementById('directoryTab').classList.contains('active')) {
                        window.renderDirectory();
                    }
                }
            }, (error) => {
                console.error("Cloud Error:", error);
            });
        }

        // --- 4. GLOBAL FUNCTIONS ---
        window.saveData = async function() {
            localStorage.setItem('aestheticTutorData', JSON.stringify(students));

            // üëá THIS IS THE FIX: Saving to the MASTER public folder üëá
            if (currentUser && db) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tutorApp', 'masterDatabase');
                    await setDoc(docRef, { students: students });
                } catch(e) {
                    console.error("Could not reach cloud:", e);
                }
            }
        }

        window.showMessage = function(msg, colorHex) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.style.borderColor = colorHex || "#ffafcc";
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        window.openTab = function(evt, tabId) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }
            const tabBtns = document.getElementsByClassName("tab-btn");
            for (let i = 0; i < tabBtns.length; i++) {
                tabBtns[i].classList.remove("active");
            }
            document.getElementById(tabId).classList.add("active");
            evt.currentTarget.classList.add("active");

            if (tabId === 'directoryTab') { window.renderDirectory(); } 
            else if (tabId === 'homeTab') { window.updateLogClassDropdown(); }
        }

        window.updateLogClassDropdown = function() {
            const selectedDay = document.getElementById('logDayFilter').value;
            const classSelect = document.getElementById('logClassFilter');
            const studentSelect = document.getElementById('attendanceStudent');
            
            let classesOnDay = new Set();
            for (let name in students) {
                if (students[name].day === selectedDay) {
                    classesOnDay.add(students[name].className || "General");
                }
            }

            classSelect.innerHTML = ''; 
            if (classesOnDay.size === 0) {
                classSelect.innerHTML = '<option disabled selected>No classes scheduled this day</option>';
                studentSelect.innerHTML = '<option disabled selected>No students available</option>';
            } else {
                classSelect.innerHTML = '<option disabled selected>Select a class...</option>';
                classesOnDay.forEach(cls => {
                    classSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
                });
                studentSelect.innerHTML = '<option disabled selected>Select a class first...</option>';
            }
            window.checkBillingType();
        }

        window.updateLogStudentDropdown = function() {
            const selectedDay = document.getElementById('logDayFilter').value;
            const selectedClass = document.getElementById('logClassFilter').value;
            const studentSelect = document.getElementById('attendanceStudent');
            
            studentSelect.innerHTML = '<option disabled selected>Select a student...</option>';
            
            let foundStudents = false;
            for (let name in students) {
                const sClass = students[name].className || "General";
                if (students[name].day === selectedDay && sClass === selectedClass) {
                    studentSelect.innerHTML += `<option value="${name}">${name}</option>`;
                    foundStudents = true;
                }
            }

            if (!foundStudents) { studentSelect.innerHTML = '<option disabled selected>No students in this class</option>'; }
            window.checkBillingType();
        }

        window.updateInvoiceDropdown = function() {
            const invoiceSelect = document.getElementById('invoiceStudent');
            const studentNames = Object.keys(students);
            
            if (studentNames.length === 0) {
                invoiceSelect.innerHTML = '<option disabled selected>Add a student first...</option>';
            } else {
                invoiceSelect.innerHTML = '<option value="" disabled selected>Select a student to invoice...</option>';
                studentNames.forEach(name => {
                    invoiceSelect.innerHTML += `<option value="${name}">${name}</option>`;
                });
            }
        }

        window.checkBillingType = function() {
            const name = document.getElementById('attendanceStudent').value;
            const container = document.getElementById('durationContainer');
            if (students[name] && students[name].billing === 'hour') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        window.addStudent = function() {
            const name = document.getElementById('studentName').value.trim();
            const gradeLevel = document.getElementById('gradeLevel').value;
            const schoolName = document.getElementById('schoolName').value.trim();
            const parentPhone = document.getElementById('parentPhone').value.trim();
            const socialMedia = document.getElementById('socialMedia').value.trim();
            
            let className = document.getElementById('className').value.trim();
            if(!className) className = "General";

            const day = document.getElementById('dayOfWeek').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const time = (startTime && endTime) ? `${startTime} - ${endTime}` : '';
            const billing = document.getElementById('billingType').value;
            const rate = parseFloat(document.getElementById('rate').value);
            
            if (name && rate) {
                if(!students[name]) { students[name] = { sessions: [] }; }
                
                students[name].grade = gradeLevel;
                students[name].school = schoolName;
                students[name].phone = parentPhone;
                students[name].social = socialMedia;
                students[name].className = className;
                students[name].day = day;
                students[name].time = time;
                students[name].billing = billing;
                students[name].rate = rate; 
                
                window.saveData(); 
                window.showMessage(`Successfully saved ${name}! ‚ú®`, "#ffafcc");
                
                document.getElementById('studentName').value = '';
                document.getElementById('schoolName').value = '';
                document.getElementById('parentPhone').value = '';
                document.getElementById('socialMedia').value = '';
                document.getElementById('gradeLevel').selectedIndex = 0;
                
                window.updateLogClassDropdown();
                window.updateInvoiceDropdown();
            } else {
                window.showMessage("Please enter both a name and a rate! üéÄ", "#ffafcc");
            }
        }

        window.logAttendance = function() {
            const name = document.getElementById('attendanceStudent').value;
            const date = document.getElementById('classDate').value;
            const status = document.getElementById('classStatus').value;
            const duration = parseFloat(document.getElementById('sessionDuration').value) || 1;
            
            if (name && name !== "Select a student..." && name !== "Select a class first..." && date && students[name]) {
                students[name].sessions.push({ date, status, duration });
                window.saveData(); 
                window.showMessage(`Logged ${status} for ${name}! üå∏`, "#b7e4c7");
                document.getElementById('attendanceStudent').value = "Select a student...";
            } else {
                window.showMessage("Please select a student and a date! üå∑", "#ffafcc");
            }
        }

        window.deleteStudent = function(name) {
            if (confirm(`Are you sure you want to completely remove ${name} from your directory?`)) {
                delete students[name];
                window.saveData();
                window.renderDirectory();
                window.updateLogClassDropdown();
                window.updateInvoiceDropdown();
                window.showMessage(`Removed ${name}. üóëÔ∏è`, "#ffc8dd");
            }
        }

        window.renderDirectory = function() {
            const container = document.getElementById('directoryContainer');
            container.innerHTML = ''; 
            
            const studentNames = Object.keys(students);
            if (studentNames.length === 0) {
                container.innerHTML = '<p style="color: var(--text-main); font-style: italic;">No students yet! Head over to the Add Student tab to get started. üéÄ</p>';
                return;
            }

            daysOfWeek.forEach(day => {
                const dayStudents = studentNames.filter(name => students[name].day === day);
                
                if (dayStudents.length > 0) {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.innerText = `üìÖ ${day}`;
                    container.appendChild(dayHeader);

                    const classGroups = {};
                    dayStudents.forEach(name => {
                        const cName = students[name].className || "General";
                        if (!classGroups[cName]) classGroups[cName] = [];
                        classGroups[cName].push(name);
                    });

                    for (let cName in classGroups) {
                        const classHeader = document.createElement('div');
                        classHeader.className = 'class-header';
                        classHeader.innerHTML = `üè´ Class: ${cName}`;
                        container.appendChild(classHeader);

                        const grid = document.createElement('div');
                        grid.className = 'directory-grid';

                        classGroups[cName].forEach(name => {
                            const s = students[name];
                            const card = document.createElement('div');
                            card.className = 'student-card';
                            card.innerHTML = `
                                <button class="delete-btn" onclick="window.deleteStudent('${name}')" title="Delete Student">‚úñ</button>
                                <h4>${name}</h4>
                                <p><span class="icon">üéì</span> <strong>Grade:</strong> ${s.grade || 'N/A'}</p>
                                <p><span class="icon">üè´</span> <strong>School:</strong> ${s.school || 'N/A'}</p>
                                <p><span class="icon">üìû</span> <strong>Parent:</strong> ${s.phone || 'N/A'}</p>
                                <p><span class="icon">üí¨</span> <strong>Contact:</strong> ${s.social || 'N/A'}</p>
                                <hr style="border: 0; border-top: 1px dashed var(--pastel-pink); margin: 10px 0;">
                                <p><span class="icon">‚è∞</span> <strong>Time:</strong> ${s.time || 'N/A'}</p>
                                <p><span class="icon">üí∞</span> <strong>Rate:</strong> $${s.rate} / ${s.billing === 'hour' ? 'hr' : 'session'}</p>
                                <p><span class="icon">üìù</span> <strong>Logs:</strong> ${s.sessions ? s.sessions.length : 0}</p>
                            `;
                            grid.appendChild(card);
                        });
                        container.appendChild(grid);
                    }
                }
            });
        }

        window.generateInvoice = function() {
            const name = document.getElementById('invoiceStudent').value;
            if (!name || !students[name]) {
                window.showMessage("Please select a valid student to invoice! üéÄ", "#a2d2ff");
                return;
            }
            
            const student = students[name];
            const presentDays = student.sessions.filter(s => s.status === 'Present');
            const leaveDays = student.sessions.filter(s => s.status === 'Leave');
            
            let total = 0;
            let hoursBilled = 0;

            if (student.billing === 'hour') {
                presentDays.forEach(s => {
                    total += s.duration * student.rate;
                    hoursBilled += s.duration;
                });
            } else {
                total = presentDays.length * student.rate;
            }
            
            let output = `‚úßÔΩ•Ôæü: *‚úßÔΩ•Ôæü:* INVOICE *:ÔΩ•Ôæü‚úß*:ÔΩ•Ôæü‚úß\n\n`;
            output += `Student:        ${name.toUpperCase()}\n`;
            output += `Class:          ${student.className || 'General'}\n`;
            output += `Schedule:       ${student.day || 'N/A'}s, ${student.time || 'N/A'}\n`;
            
            if (student.billing === 'hour') { output += `Hourly Rate:    $${student.rate}/hr\n`; } 
            else { output += `Session Rate:   $${student.rate}/session\n`; }
            
            output += `--------------------------------\n`;
            output += `Total Classes Logged: ${student.sessions.length}\n`;
            output += `Classes Attended:     ${presentDays.length} ‚úÖ\n`;
            output += `Classes on Leave:     ${leaveDays.length} ‚òï\n`;
            
            if (student.billing === 'hour' && presentDays.length > 0) { output += `Total Hours Taught:   ${hoursBilled} hrs\n`; }
            
            output += `--------------------------------\n`;
            output += `TOTAL AMOUNT DUE:     $${total}\n\n`;
            output += `Thank you for learning with me! üíï`;
            
            const outputEl = document.getElementById('invoiceOutput');
            outputEl.innerText = output;
            outputEl.style.display = 'block'; 
            window.showMessage("Invoice generated! ‚òÅÔ∏è", "#a2d2ff");
        }

        window.onload = function() {
            document.getElementById('classDate').valueAsDate = new Date();
            const todayIndex = new Date().getDay();
            const jsDaysToDropdownDays = [6, 0, 1, 2, 3, 4, 5]; 
            document.getElementById('logDayFilter').selectedIndex = jsDaysToDropdownDays[todayIndex];

            window.updateLogClassDropdown();
            window.updateInvoiceDropdown();
        };
    </script>
